[tools]
go = "latest"
python = "3.8"
ruby = "latest"
"ubi:adwinying/php" = "8.4.10"

[settings]
idiomatic_version_file_enable_tools = ['ruby']

[tasks.catchup]
description = "Rebase the current branch onto origin/dev."
run = [
	'git fetch origin',
	'git rebase origin/dev',
]

[tasks.build]
description = "Create fresh builds of all the project images."
run = [
	'docker compose down -v',
	'docker compose build --no-cache',
]

[tasks.restore]
description = "Down/up the containers and restore to a recent sql dump."
run = [
	'docker compose down -v',
	'docker compose up postgres --wait',
	'docker compose exec postgres bash -c "pg_restore -U redmine -d postgres -Cc -j 4 backup/redmine_development.sqlc --clean"',
	'docker compose up -d',
]

[tasks.console]
description = "Open a console in the container."
usage = '''
arg "<environment>" {
	choices "test" "development"
	default "development"
}
'''
run = 'docker compose exec redmine bash -c "RAILS_ENV=${usage_environment} rails console"'

[tasks.gitlab_test]
description = "Run the test suite as it is in Gitlab."
run = [
	'docker compose up redmine -d',
	'docker compose cp config/redmine_test.sqlc postgres:/backup/redmine_test.sqlc',
	'docker compose exec -e RAILS_ENV=test redmine bash -c "rails db:drop db:create"',
	'docker compose exec postgres bash -c "pg_restore -U redmine -d redmine_test -j 4 /backup/redmine_test.sqlc"',
	'docker compose exec -e RAILS_ENV=test redmine bash -c "rails db:migrate redmine:plugins:migrate && rails data:migrate"',
	'docker compose exec -e RUBYOPT="--disable-frozen-string-literal" -e RAILS_ENV=test redmine bash -c "rails test -f plugins/portal/test/"${2}" --verbose"',
]

[tasks.build_test]
description = "Build the testing environment."
run = '''
	'docker compose exec redmine bash -c "RAILS_ENV=test rake db:drop db:create db:migrate"',
	'docker compose exec redmine bash -c "RAILS_ENV=test rake redmine:plugins:migrate"',
	'docker compose exec redmine bash -c "RAILS_ENV=test rails data:migrate"',
'''

[tasks.test]
description = 'Run tests after build_test. Run with an argument specifying a relative path under plugins/portal/test to run a specific test.'
usage = '''
	flag "-f --file <file>" help="A specific file or dir to be tested instead of the whole suite."
'''
run = 'docker compose exec redmine bash -c "RAILS_ENV=test rails test plugins/portal/test/${usage_file} --verbose"'
